
.weak
  WARNINGS :?= "None"
.endweak

GUARD_FE5_CHAPTER03 :?= false
.if (!GUARD_FE5_CHAPTER03)
  GUARD_FE5_CHAPTER03 := true

  ; Definitions

    .weak

      rlEventEngineCancelFading :?= address($8C8461)

    .endweak

  ; Freespace inclusions

    .section Chapter03EventsSection

      eventChapter03Events ; 8C/E435

        ; Flag definitions

          _FlagLobosBattleQuote     = enum.enum($06)

          ; TODO: map installer definitions

          _FlagDoor1                = enum.enum()

        _OpeningEventDefinitions ; 8C/E435
          EVENT FlagAlwaysZero, _OpeningEvent
            CMP_WORD wCurrentTurn, 0
          END_DEFINITION
        END_DEFINITION_ARRAY

        _TurnEventDefinitions ; 8C/E442
        END_DEFINITION_ARRAY

        _TalkEventDefinitions ; 8C/E4AE
        END_DEFINITION_ARRAY

        _LocationEventDefinitions ; 8C/E4B0
          EVENT FlagAlwaysZero, _EndingEvent
            macroECCheckCoordinates [14, 2]
            CMP_WORD wCurrentPhase, Player
            CMP_WORD aSelectedCharacterBuffer.Character, Finn
          END_DEFINITION
        END_DEFINITION_ARRAY

        _BeforeActionEventDefinitions ; 8C/E68A
        END_DEFINITION_ARRAY

        _AfterActionEventDefinitions ; 8C/E68C
        END_DEFINITION_ARRAY

        _BattleEventDefinitions ; 8C/E68E
          macroECBossQuote _FlagLobosBattleQuote, Lobos
        END_DEFINITION_ARRAY

        _ShopEventDefinitions ; 8C/E698
        END_DEFINITION_ARRAY


        _PrepGroups ; 8C/EAC2
        .word 0

        _OpeningEvent ; 8C/EAC4
          STORE_WORD wCurrentChapter, Chapter24x
          CALL_ASM_SKIPPABLE $9A98B8

          PLAY_SOUND_FORCED $00E0
          PAUSE_SKIPPABLE 32
          YIELD

          FADE_IN 2 

          SET_CAMERA_POSITION [4, 34]
          YIELD

          macroChapterTitlePopup dialogueChapter03Title

          SCROLL_CAMERA_COORDS [8, 7], 4
          YIELD

          MOVE_CHAR Raydrik, [12, 12], 1

          WAIT_MOVE
          YIELD

          SCROLL_CAMERA_COORDS [12, 9], 4

          macroOpenDoorByTileChangeID 0

          MOVE_CHAR Raydrik, [11, 11], 1, _RaydrikMovestring1

          MOVE_CHAR Lobos, [13, 5], 1

          PAUSE_SKIPPABLE 64
          YIELD

          macroASMCSingleTileChangeByCoords [12, 11], $03A5

          PLAY_EXTENDED_SOUND $6C
          WAIT_MOVE
          YIELD

          MOVE_CHAR Lobos, [12, 5], 1

          WAIT_MOVE
          YIELD

          DIALOGUE dialogueChapter03Opening1
          YIELD

          MOVE_CHAR Raydrik, [15, 1], 1, _RaydrikMovestring2

          WAIT_MOVE
          YIELD

          macroASMCRemoveUnit Raydrik

          MOVE_CHAR Lobos, [12, 4], 1

          WAIT_MOVE
          YIELD

          SCROLL_CAMERA_ADDRESS eventChapter03Data._EnemyGroup1CameraCoordinates
          YIELD

          LOAD_GROUP eventChapter03Data._EnemyGroup1
          WAIT_MOVE
          YIELD

          SCROLL_CAMERA_ADDRESS eventChapter03Data._EnemyGroup3CameraCoordinates
          YIELD

          LOAD_GROUP eventChapter03Data._EnemyGroup3
          WAIT_MOVE
          YIELD

          SCROLL_CAMERA_ADDRESS eventChapter03Data._EnemyGroup2CameraCoordinates
          YIELD

          LOAD_GROUP eventChapter03Data._EnemyGroup2
          WAIT_MOVE
          YIELD

          SCROLL_CAMERA_ADDRESS eventChapter03Data._EnemyGroup4CameraCoordinates
          YIELD

          LOAD_GROUP eventChapter03Data._EnemyGroup4
          WAIT_MOVE
          YIELD

          SCROLL_CAMERA_ADDRESS eventChapter03Data._EnemyGroup5CameraCoordinates
          YIELD

          LOAD_GROUP eventChapter03Data._EnemyGroup5
          WAIT_MOVE
          YIELD

          PLAY_SOUND_FORCED $00E0
          PAUSE_SKIPPABLE 32
          YIELD

          SET_MUSIC $32
          YIELD

          SCROLL_CAMERA_CHAR Leif, 4

          DIALOGUE dialogueChapter03Opening2
          YIELD

          MOVE_UNIT ThraciaBishop, [11, 28], [1, 27], 1
          YIELD_UNK

          WAIT_MOVE
          YIELD

          macroASMCRemoveUnit ThraciaBishop

          MOVE_UNIT ThraciaBishop, [11, 28], [11, 27], 1, _BishopMovestring
          YIELD_UNK

          macroASMCRemoveUnit ThraciaBishop
        END2

        _BishopMovestring ; 8C/EC70
          MS_MOVE_UP
        MS_END

        _RaydrikMovestring1 ; 8C/EC72
          MS_MOVE_UP
          MS_MOVE_UP
          MS_MOVE_LEFT
          MS_MOVE_LEFT
          MS_MOVE_LEFT
          MS_MOVE_UP
          MS_MOVE_UP
          MS_MOVE_UP
          MS_MOVE_LEFT
          MS_MOVE_LEFT
          MS_MOVE_UP
          MS_MOVE_UP
          MS_MOVE_RIGHT
          MS_MOVE_RIGHT
          MS_MOVE_RIGHT
          MS_MOVE_RIGHT
          MS_MOVE_RIGHT
          MS_MOVE_UP
        MS_END

        _RaydrikMovestring2 ; 8C/EC85
          MS_MOVE_RIGHT
          MS_MOVE_RIGHT
          MS_MOVE_RIGHT
          MS_MOVE_RIGHT
          MS_MOVE_UP
          MS_MOVE_UP
          MS_MOVE_UP
        MS_END

        _EndingEvent ; 8C/EC8D
          STORE_WORD wCurrentMapMusic, $00

          PAUSE_SKIPPABLE 16
          YIELD

          CALL_ASM_LOOP rlASMCSaveActiveUnitClearHDMA
          CALL_ASM_LOOP rlASMCSaveChapterTurncount

          SET_CAMERA_POSITION [11, 26]
          YIELD


          FADE_OUT 1
          YIELD

          CALL_ASM_LOOP rlASMCChapterEnd

        END1

    .endsection Chapter03EventsSection

    .section Chapter03DataSection

      eventChapter03Data ; B1/F318

<<<<<<< HEAD
        _UnusedCoordinates1 ; B1/F318
          .byte [11, 11]

        _BossesGroup ; B1/F31A
          UNIT Lobos, Enemy, [12, 4], [12, 4], Lobos, [Longbow, ShortLance], 1, true, [$01, $03, $00, $80]
          UNIT Raydrik, Enemy, [14, 19], [14, 19], Raydrik, [], 1, false, [$00, $00, $00, $00]
        UNIT

        _EnemyGroup1CameraCoordinates ; B1/F344
          .byte [13, 8]

        _EnemyGroup1 ; B1/F346
          UNIT MunsterArmoredSword, Enemy, [7, 6], [7, 6], Lobos, [Shortsword, Vulnerary], 8, false, [$19, $03, $00, $00]
          UNIT MunsterArmoredSword, Enemy, [15, 10], [15, 10], Lobos, [Shortsword, DoorKey, Vulnerary], 8, false, [$19, $03, $00, $00]
          UNIT MunsterSoldier2, Enemy, [9, 5], [9, 5], Lobos, [ShortLance], 12, false, [$19, $03, $00, $00]
          UNIT MunsterSoldier2, Enemy, [9, 10], [9, 10], Lobos, [ShortLance], 9, false, [$19, $29, $00, $00]
          UNIT MunsterSoldier2, Enemy, [18, 7], [18, 7], Lobos, [ShortLance], 10, false, [$19, $29, $00, $00]
          UNIT MunsterSoldier2, Enemy, [3, 5], [3, 5], Lobos, [ShortLance], 8, false, [$19, $29, $00, $00]
          UNIT MunsterBishop2, Enemy, [15, 3], [15, 3], Lobos, [Elfire, Heal, DoorKey, ChestKey], 10, false, [$08, $03, $00, $00]
        UNIT

        _EnemyGroup2CameraCoordinates ; B1/F3D4
          .byte [17, 14]

        _EnemyGroup2 ; B1/F3D6
          UNIT MunsterArmoredBow, Enemy, [18, 13], [18, 13], Lobos, [Shortbow, Vulnerary], 7, false, [$19, $03, $00, $00]
          UNIT MunsterSoldier2, Enemy, [23, 15], [23, 15], Lobos, [ShortLance, Vulnerary], 13, false, [$19, $29, $00, $00]
          UNIT MunsterSoldier2, Enemy, [21, 12], [21, 12], Lobos, [ShortLance], 13, false, [$19, $29, $00, $00]
        UNIT

        _EnemyGroup3CameraCoordinates ; B1/F414
          .byte [8, 10]

        _EnemyGroup3 ; B1/F416
          UNIT MunsterThunderMage, Enemy, [1, 11], [1, 11], Lobos, [Fire], 6, false, [$19, $29, $00, $00]
          UNIT MunsterSoldier2, Enemy, [4, 11], [4, 11], Lobos, [ShortLance], 11, false, [$19, $29, $00, $00]
        UNIT

        _EnemyGroup4CameraCoordinates ; B1/F440
          .byte [13, 16]

        _EnemyGroup4 ; B1/F442
          UNIT MunsterSoldier2, Enemy, [12, 15], [12, 15], Lobos, [ShortLance, DoorKey], 10, false, [$19, $03, $00, $00]
          UNIT MunsterArcher, Enemy, [13, 14], [13, 14], Lobos, [Shortbow], 10, false, [$19, $03, $00, $00]
          UNIT MunsterArcher, Enemy, [10, 13], [11, 14], Lobos, [Shortbow], 10, false, [$19, $03, $00, $00]
        UNIT

        _EnemyGroup5CameraCoordinates ; B1/F480
          .byte [8, 23]

        _EnemyGroup5 ; B1/F482
          UNIT MunsterArcher, Enemy, [6, 23], [6, 23], Lobos, [Shortbow], 10, false, [$19, $29, $00, $00]
          UNIT MunsterSoldier2, Enemy, [4, 23], [4, 23], Lobos, [ShortLance, Vulnerary], 11, false, [$19, $29, $00, $00]
          UNIT MunsterSoldier2, Enemy, [5, 29], [5, 25], Lobos, [ShortLance], 12, false, [$19, $29, $00, $00]
        UNIT

        _SoldierReinforcementsCameraCoordinates ; B1/F4C0
          .byte [8, 8]

        _SoldierReinforcementsGroup ; B1/F4C2
          UNIT MunsterSoldier2, Enemy, [8, 1], [8, 1], Lobos, [ShortLance], 7, false, [$00, $00, $00, $00]
        UNIT

        _ArmorReinforcementsCameraCoordinates ; B1/F4D8
          .byte [17, 8]

        _ArmorReinforcementsGroup ; B1/F4DA
          UNIT MunsterArmoredSword, Enemy, [16, 1], [16, 1], Lobos, [Shortsword], 8, false, [$00, $00, $00, $00]
        UNIT

        _Brigand1ReinforcementsCameraCoordinates ; B1/F4F0
          .byte [8, 21]

        _Brigand1ReinforcementsGroup1 ; B1/F4F2
          UNIT BanditBrigand1, Enemy, [0, 21], [1, 21], Seil, [IronAxe], 5, false, [$19, $09, $00, $00]
        UNIT

        _Brigand2ReinforcementsCameraCoordinates ; B1/F508
          .byte [8, 21]

        _Brigand2ReinforcementsGroup1 ; B1/F50A
          UNIT BanditBrigand1, Enemy, [0, 21], [1, 21], Seil, [IronAxe], 5, false, [$02, $09, $00, $00]
        UNIT

        _UnusedCoordinates2 ; B1/F520
          .byte [13, 8]

        _NPCGroup ; B1/F522
          UNIT Romeo, NPC, [12, 8], [12, 8], Ishtar, [], 1, false, [$02, $03, $00, $00]
          UNIT Luccia, NPC, [14, 8], [14, 8], Ishtar, [], 1, false, [$02, $03, $00, $00]
          UNIT Tailtiu, NPC, [13, 7], [13, 7], Ishtar, [], 1, false, [$02, $03, $00, $00]
          UNIT Jubel, NPC, [11, 7], [11, 7], Ishtar, [], 1, false, [$02, $03, $00, $00]
        UNIT

        _UnusedCoordinates3 ; B1/F574
          .byte [13, 8]

        _BishopGroup ; B1/F576
          UNIT ThraciaBishop, Player, [11, 28], [11, 28], Leif, [], 1, false, [$00, $00, $00, $00]
        UNIT

        _UnusedCoordinates4 ; B1/F58C
          .byte [8, 7]

        _Brigand2ReinforcementsGroup2 ; B1/F58E
          UNIT BanditBrigand1, Enemy, [0, 22], [1, 22], Seil, [IronAxe], 5, false, [$02, $09, $00, $00]
        UNIT

        _UnusedCoordinates5 ; B1/F5A4
          .byte [8, 26]

        _Brigand1ReinforcementsGroup2 ; B1/F5A6
          UNIT BanditBrigand1, Enemy, [0, 22], [1, 22], Seil, [IronAxe], 5, false, [$02, $09, $00, $00]
        UNIT

        _StartingPositions ; B1/F5BC
          .byte [1, 1]
          .byte [1, 3]
          .byte [6, 1]
        .char -1



    .endsection Chapter03DataSection

    .section Chapter03WorldMapEventsSection

      eventChapter03WorldMapEvents ; E7/E336

        SCROLL_CAMERA_COORDS [20, 14], 4
        SET_CURSOR_POSITION
        YIELD

        PLAY_SOUND_FORCED $00E0
        PAUSE_SKIPPABLE 32
        YIELD

        SET_MUSIC $29
        YIELD

        FADE_IN 1
        YIELD

        SCROLL_CAMERA_COORDS [20, 12], 1
        SET_CURSOR_POSITION
        YIELD

        macroWMSetCyclePalette 0, aBGPaletteBuffer.aPalette6

        macroWMDrawSpecialMarker [96, 80], WMMarkerTable.Crown, 0

        macroASMCWMDialogue dialogueChapter03WorldMap1
        HALT_UNTIL_WORD_SKIPPABLE wDialogueEngineStatus, $0000

        macroWMClearSpecialMarker 0

        PAUSE_SKIPPABLE 3
        YIELD

        macroWMDrawSpecialMarker [136, 112], WMMarkerTable.Circle, 0

        macroASMCWMDialogue dialogueChapter03WorldMap2
        HALT_UNTIL_WORD_SKIPPABLE wDialogueEngineStatus, $0000

        macroWMClearCyclePalette aBGPaletteBuffer.aPalette6

        macroWMClearSpecialMarker 0

        PAUSE_SKIPPABLE 1
        YIELD

        PAUSE_SKIPPABLE 1
        YIELD

        FADE_OUT 2
        YIELD

        CALL_ASM_LOOP rlASMCEndWMEvents
        YIELD
      END1

    .endsection Chapter03WorldMapEventsSection


.endif ; GUARD_FE5_CHAPTER03